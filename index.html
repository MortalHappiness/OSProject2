<!DOCTYPE HTML>
<!--
	Hyperspace by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Hyperspace by HTML5 UP</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
	</head>
	<body class="is-preload">

		<!-- Sidebar -->
			<section id="sidebar">
				<div class="inner">
					<nav>
						<ul>
							<li><a href="#intro">Welcome</a></li>
							<li><a href="#design">Design</a></li>
							<li><a href="#demo">Demo</a></li>
							<li><a href="#evaluation">Evaluation</a></li>
							<li><a href="#discussion">Discussion</a></li>
							<li><a href="#repo">Repo</a></li>
							<li><a href="#reference">Reference</a></li>
						</ul>
					</nav>
				</div>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Intro -->
					<section id="intro" class="wrapper style1 fullscreen fade-up">
						<div class="inner">
							<h1>OS Project 2</h1>
							<p>This website is for Project 2 of the NTU 2020 Operating system course.<br /></p>
							<h2>Group 9</h2>
							<h3>Member:</h3>
							<ul>
								<li>B07901069  劉奇聖</li>
								<li>B05202050  劉安浚</li>
								<li>B05901184  賴言禮</li>
								<li>B07901184  陳映樵</li>
								<li>B05103055  黃子瑋</li>
							</ul>
						</div>
					</section>

				<!-- Design -->
					<section id="design" class="wrapper style2 fade-up">
						<div class="inner">
							<h2>Design</h2>
							<div class>
								<section>
									<span class="icon solid major fa-link"></span>
									<h3>Input parameters</h3>
									<p>Input parameter的部份我設計成和sample一樣，但是在parameter數目不對的時候會print usage出來，例如說有2個檔案輸入但卻只給一個檔名就會print出help message。</p>
								</section>
								<section>
									<span class="icon solid major fa-lock"></span>
									<h3>Parameter choices</h3>
									<p>BUF_SIZE為512，MAP_SIZE為8192（兩個page大）。</p>
								</section>
								<section>
									<span class="icon solid major fa-code"></span>
									<h3>Master side</h3>
									<h4>(a) User program</h4>
									<p>一開始會先把master device打開，如果method是mmap的話則將device mmap到一段MAP_SIZE大的記憶體，接著對於每個檔案計算檔案大小並把它們打開，並且為該檔案開一個socket接收來自slave的連接。如果method是fcntl的話就不斷read檔案並write到device；如果是mmap的話則不斷把檔案mmap到一段不大於MAP_SIZE的記憶體，並把該記憶體的內容copy到device的mmap，再call ioctl叫device把內容傳出去，直到所有檔案都傳出去為止。</p>
									<h4>(b) Master device</h4>
									<p>只要user_program call write就把message copy到一個buffer，再把該buffer的內容傳出去。如果user_program call mmap的話則allocate一塊MAP_SIZE大的記憶體並把該段記憶體的所有page設成reserved避免被swap out，再把該段記憶體map到user space，user_program call munmap再free掉該記憶體，當user_program call ioctl的時候就把該段記憶體的內容傳出去。</p>
								</section>
								<section>
									<span class="icon solid major fa-code"></span>
									<h3>Slave sice</h3>
									<h4>(a) User program</h4>
									<p>一開始會先把slave device打開，如果method是mmap的話則將device mmap到一段MAP_SIZE大的記憶體，接著對於每個檔案把檔案打開，為該檔案開一個socket連接到master。如果method是fcntl的話就不斷read device並write到file裡；如果是mmap的話則不斷call ioctl叫device把接收到的檔案放在device mmap裡，接著再根據devicereturn的value得知file需要增長多大，ftruncate並mmap該file，最後再把device mmap的內容copy到file mmap，直到所有檔案都接收到為止。</p>
									<h4>(a) Slave device</h4>
									<p>只要user_program call read就從socket接收message到一個buffer，再把該buffer的內容copy到user space指定的buffer。如果user_program call mmap的話則allocate一塊MAP_SIZE大的記憶體並把該段記憶體的所有page設成reserved避免被swap out，再把該段記憶體map到user space，user_program call munmap再free掉該記憶體，當user_program call ioctl的時候就不斷從socket接收message直到填滿該段記憶體或沒有message接收，再return寫了多長的message到該段記憶體回user_program。</p>
								</section>
								<section>
									<span class="icon solid major fa-gem"></span>
									<h3>Test dataset</h3>
									<h4>(a) sample_input_1</h4>
									<p>助教提供的測資，裡面包含數個較小的純文字檔。</p>
									<h4>(b) sample_input_2</h4>
									<p>助教提供的測資，裡面包含一個較大的純文字檔。</p>
									<h4>(c) pdf</h4>
									<p>這個資料夾裏面放的都是pdf檔，想測試看看非文字檔會不會傳成功。</p>
									<h4>(d) medium_case</h4>
									<p>內含4個4096 bytes的檔案，想測試檔案大小恰好為一個page size大的時候的效能。</p>
									<h4>(e) medium_case_off</h4>
									<p>內含4個4097 bytes的檔案，想測試檔案大小為比一個page size大一個byte的時候效能是否與 (d) 有差異。</p>
								</section>
							</div>
						</div>
					</section>

				<!-- Demo -->
					<section id="demo" class="wrapper style3 fade-up">
						<div class="inner">
							<h2>Demo</h2>
							<p>This is our Demo video.</p>
							<div>
								<iframe width="1080" height="720" src="images/demo.mp4" 
								  frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
								  allowfullscreen>
								Demo video
							    </iframe>
							</div>
						</div>
					</section>

				<!-- Evalutaion -->
				    <section id="evaluation" class="wrapper style1 fade-up">
						<div class="inner">
							<h2>Evaluation</h2>
							<p>在output資料夾中有output_file和time_size兩個資料夾，output_file中的檔案完全和input一樣（有diff過）。time_size的話對於每個測資有fnctl和mmap的兩種結果，每個檔案點開會有5行，此為我們對每組測資各跑五次以方便取平均和標準差做效能分析。</p>
							<p>以下的表格為各測資的執行時間平均及標準差，表格下方的兩張圖片為mmap時master端和slave端的page descriptors。</p>
							<div>
								<h3>Sample input 1: 23462 bytes</h3>
								<table style="width:100%">
                                    <thead>
										<tr>
											<th>Time (ms)</th>
											<th>fcntl</th>
											<th>mmap</th>
										</tr>
									</thead>
									<tr>
									  <td>MEAN</td>
									  <td>0.63496</td>
									  <td>0.5955</td>
									</tr>
									<tr>
									  <td>STD</td>
									  <td>0.011313</td>
									  <td>0.017003</td>
									</tr>
								</table>
								<img src="images/s1_master.png" alt="HTML5 Icon" width="1080" height="44">
								<img src="images/s1_slave.png" alt="HTML5 Icon" width="1080" height="44">
                            

								<h3>Sample input 2: 12022885 bytes</h3>
								<table style="width:100%">
                                    <thead>
										<tr>
											<th>Time (ms)</th>
											<th>fcntl</th>
											<th>mmap</th>
										</tr>
									</thead>
									<tr>
									  <td>MEAN</td>
									  <td>27.46266</td>
									  <td>11.72702</td>
									</tr>
									<tr>
									  <td>STD</td>
									  <td>5.1692</td>
									  <td>0.4695</td>
									</tr>
								</table>
								<img src="images/s2_slave.png" alt="HTML5 Icon" width="1080" height="44">
								<img src="images/s2_master.png" alt="HTML5 Icon" width="1080" height="44">
								
								<h3>PDF: 2379921 bytes</h3>
								<table style="width:100%">
                                    <thead>
										<tr>
											<th>Time (ms)</th>
											<th>fcntl</th>
											<th>mmap</th>
										</tr>
									</thead>
									<tr>
									  <td>MEAN</td>
									  <td>5.5733</td>
									  <td>2.5198</td>
									</tr>
									<tr>
									  <td>STD</td>
									  <td>0.07567</td>
									  <td>0.04425</td>
									</tr>
								</table>
								<img src="images/pdf_slave.png" alt="HTML5 Icon" width="1080" height="44">
								<img src="images/pdf_master.png" alt="HTML5 Icon" width="1080" height="44">

								<h3>medium_case: 16384 bytes</h3>
								<table style="width:100%">
                                    <thead>
										<tr>
											<th>Time (ms)</th>
											<th>fcntl</th>
											<th>mmap</th>
										</tr>
									</thead>
									<tr>
									  <td>MEAN</td>
									  <td>0.282</td>
									  <td>0.28908</td>
									</tr>
									<tr>
									  <td>STD</td>
									  <td>0.008969</td>
									  <td>0.02352</td>
									</tr>
								</table>
								<img src="images/medium_slave.png" alt="HTML5 Icon" width="1080" height="44">
							    <img src="images/medium_master.png" alt="HTML5 Icon" width="1080" height="44">

								<h3>medium_case_off: 16388 bytes</h3>
								<table style="width:100%">
                                    <thead>
										<tr>
											<th>Time (ms)</th>
											<th>fcntl</th>
											<th>mmap</th>
										</tr>
									</thead>
									<tr>
									  <td>MEAN</td>
									  <td>0.2895</td>
									  <td>0.26266</td>
									</tr>
									<tr>
									  <td>STD</td>
									  <td>0.01668</td>
									  <td>0.007343</td>
									</tr>
								</table>
								<img src="images/medium_off_slave.png" alt="HTML5 Icon" width="1080" height="44">
								<img src="images/medium_off_master.png" alt="HTML5 Icon" width="1080" height="44">

							</div>

							<h3>Result:</h3>
							<p>fcntl在實作上會需要大量的system call，而通常system call會較memory operation花上不少時間，所以我們可以預測mmap會比起fcntl還要有效率。而從我們的實驗結果可以看出，在檔案較大的時候（sample_input_2 and pdf）時，mmap相比fcntl速度為fcntl的2倍以上，而在檔案較小的情況之下（sample_input_1 and medium_case），兩者的效率差不多，我們猜測可能是因為在小檔案的情況下，mmap initialize的時候所產生的page fault以及連帶的更新TLB裡的資訊所花的時間會抵消mmap理論上對fcntl的優勢，所以才會表現出兩者效率沒有相差多少的情形。甚者，我們可以預測在file size很小的時候，fcntl的效率會比mmap好。</p>
						    <p>在stability方面，我們可以看到每一組執行五次時間的標準差都小於0.1，因此效能上很穩定，不會有一些很糟糕的情況發生（除了fcntl sample_input_2，可看到前三次都二十幾ms，後兩次三十幾ms，推測是傳大檔案時網路的穩定性問題，如後兩次突然queuing delay變大等）。</p>
						</div>
					</section>

				<!-- Discussion -->
					<section id="discussion" class="wrapper style2 fade-up">
						<div class="inner">
							<h2>Discussion</h2>
							<h3>mmap 優點：</h3>
							<ol>
								<li>一般I/O需要將資料寫到buffer且存取速度慢。而mmap將資料映射到虛擬記憶體上，通過對這段記憶體的讀取和修改，實現對文件的讀取和修改，因為省去buffer這一層的緣故，mmap速度較快。</li>
								<li>通常呼叫一次system call的成本相對較高，因為CPU除了需要處理interrupt之外，還需要做context switch，因此成本相對一般function高。而mmap只有一開始的時候需要去分配記憶體之外，其他時候就可以交由user application去直接操作記憶體，相比read()或是write()需要讓系統一次又一次的去處理I/O，許多不必要的overhead可以去掉，因此mmap相比fcntl來說更有效率。</li>
								<li>呼叫fcntl的read()或write()這兩個system call時需要copy_from_user()或copy_to_user()，也就是要使data在kernel space以及user space之間轉移，然而因為mmap是直接讓user可以直接access到device的memory，因此這一層轉移在mmap就可以省略，因此較fcntl來說更省時間。</li>
							</ol>
							<h3>mmap 缺點：</h3>
							<ol>
								<li>mmap分配的記憶體空間都是以page size為最小單位，如此一來若將小檔案map在記憶體上，可能會有page使用率不高的問題，造成internal fragmentation。</li>
								<li>相比fcntl來說，mmap需要在device端額外實作，因此對於developer的負擔比較大。另外因為mmap在實作方面比較複雜，因此在檔案較小的情況下，fcntl這種比較簡單的方法會顯得較有效率。</li>
							</ol>
							<h3>Conclusion：</h3>
							<p>雖然mmap可能會浪費比較多記憶體空間，或是在檔案較小時performance較差，但是在一般的情況下來說mmap的速度會比fcntl快上2~3倍，因此如果開發者有能力的話，基本上建議實作mmap，而使用者來說用mmap的效率會比一般的I/O高上不少。</p>
						</div>
					</section>

				<!-- Repository -->
					<section id="repo" class="wrapper style3 fade-up">
						<div class="inner">
							<h2>Repository</h2>
							<p>This is the link of our reppository.</p>
							<ul class="actions">
								<li><a href="https://github.com/MortalHappiness/OSProject2" class="button" target="_blank">OS Project 2</a></li>
							</ul>
						</div>
					</section>

				<!-- Reference -->
				    <section id="reference" class="wrapper style1 fade-up">
						<div class="inner">
							<h2>Reference</h2>
							<ol>
								<li><a href="https://linux-kernel-labs.github.io/refs/heads/master/labs/memory_mapping.html?fbclid=IwAR1jZGBSMkknbMdXj45a6zPlwAlu3_0b-rxLxlvr613ZuONCD3VPWA5Rbu4" target="_blank">linux kernel labs</a></li>
								<li><a href="https://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank">mmap</a></li>
								<li><a href="https://lwn.net/images/pdf/LDD3/ch15.pdf" target="_blank">Memory mapping and DMA</a></li>
								<li><a href="http://rswiki.csie.org/lxr/http/source/include/linux/mm_types.h?v=linux-4.5.4#L44" target="_blank">rswiki-linux-4.5.4</a></li>
								<li><a href="https://www.man7.org/linux/man-pages/man2/ioctl.2.html" target="_blank">ioctl</a></li>
								<li><a href="https://man7.org/linux/man-pages/man2/ftruncate.2.html" target="_blank">ftruncate</a></li>
							</ol>
						</div>
					</section>
				
			</div>

		<!-- Footer -->
			<footer id="footer" class="wrapper style1-alt">
				<div class="inner">
					<ul class="menu">
						<li>&copy; All rights reserved.</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
					</ul>
				</div>
			</footer>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

	</body>
</html>